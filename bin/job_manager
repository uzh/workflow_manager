#!/usr/bin/env ruby
# encoding: utf-8
# Version = '20210723-163220'

require 'optparse'
Version = WorkflowManager::VERSION
unless ARGV[0]
  puts <<-eos
    Version: #{Version}\nUsage:\n #{File.basename(__FILE__)} -d [druby://host:port]
  eos
  exit
end

uri = if i = ARGV.index("-d")
        ARGV[i+1]
      else
        "druby://localhost:40001"
      end
workflow_manager_pid = fork do
  #exec("bundle exec workflow_manager -d druby://fgcz-h-032:40005 -m production")
  exec("bundle exec workflow_manager -d #{uri} -m production")
end

sleep 1

sidekiq_pid = fork do
  exec("sidekiq -C config/environments/sidekiq.yml -r ./lib/job_checker.rb")
end

sleep 1

begin
  Process.waitall
  puts "__END__"
rescue SignalException
  Process.kill("HUP", sidekiq_pid)
  sleep 1
#  Process.kill("HUP", redis_pid)
#  sleep 1
  Process.kill("HUP", workflow_manager_pid)
  puts "__CORRECTLY_END__"
end

